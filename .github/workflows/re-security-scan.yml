name: "[REUSABLE] On-demand Security Scan (Grype + Trivy)"
on:
  workflow_call:
    inputs:
      target:
        description: "Scan part 'docker' or 'source'"
        default: "docker"
        type: string
      image:
        description: "Docker image (for docker). By default ghcr.io/<owner>/<repo>:latest"
        required: false
        default: ""
        type: string
      only-high-critical:
        description: "Scope only HIGH + CRITICAL"
        required: false
        default: true
        type: boolean
      trivy-scan:
        description: "Trivy scan"
        required: false
        default: true
        type: boolean
      grype-scan:
        description: "Grype scan"
        required: false
        default: true
        type: boolean
      continue-on-error:
        description: "Continue on error"
        required: false
        default: true
        type: boolean
      only-fixed:
        description: "Ignore unfixed vulnerabilities"
        required: false
        default: true
        type: boolean
      upload-sarif-to-security:
        description: "Upload SARIF files to repository's Security"
        type: boolean
        required: false
        default: true
      runner:
        description: "runs-on runner"
        type: string
        required: false

permissions:
  contents: read
  security-events: write
  packages: read

env:
  GRYPE_SEVERITY: "critical"
  TARGET: ${{ inputs.target }}
  TRIVY_SEVERITY: >-
    ${{ inputs['only-high-critical'] && 'HIGH,CRITICAL' || 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL' }}
  INCOMMING_IMAGE: >-
    ${{ inputs.target == 'docker' && (inputs.image != '' && inputs.image || format('ghcr.io/{0}:latest', github.repository)) || '' }}

jobs:
  init:
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    outputs:
      GRYPE_FILENAME: ${{ steps.prepare-outputs.outputs.GRYPE_FILENAME }}
      TRIVY_FILENAME: ${{ steps.prepare-outputs.outputs.TRIVY_FILENAME }}
      IMAGE: ${{ steps.normalize-image.outputs.IMAGE }}
      IMAGE_SHORT_NAME: ${{ steps.prepare-outputs.outputs.IMAGE_SHORT_NAME }}
    steps:
      - name: Scan plan
        run: |
          echo "Mode: ${TARGET}"
          echo "Image (if docker): ${INCOMMING_IMAGE}"
          echo "Only high+critical: ${{ inputs['only-high-critical'] }}"
          if [ "${TARGET}" = "docker" ]; then
            echo "   - Docker scan: enabled"
          else
            echo "   - Docker scan: skipped"
          fi
          if [ "${TARGET}" = "source" ]; then
            echo "   - Source scan: enabled"
          else
            echo "   - Source scan: skipped"
          fi

      - name: Normalize IMAGE to lowercase
        if: ${{ inputs.target == 'docker' }}
        id: normalize-image
        run: |
          IMAGE="$INCOMMING_IMAGE"
          IMAGE_LOWER=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          echo "Normalized IMAGE: $IMAGE_LOWER"
          echo "IMAGE=$IMAGE_LOWER" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR (for check)
        if: ${{ inputs.target == 'docker' }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 #v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check that image exists in registry
        if: ${{ inputs.target == 'docker' }}
        env:
          IMAGE: ${{ steps.normalize-image.outputs.IMAGE }}
        run: |
          echo "Checking image in registry: $IMAGE"
          if ! docker manifest inspect "$IMAGE" >/dev/null 2>&1; then
            echo "❌ Image not found in registry: $IMAGE"
            exit 1
          fi
          echo "✅ Image exists in registry: $IMAGE"

      - name: Prepare filenames
        id: prepare-outputs
        env:
          RUNNER: "${{ inputs.runner }}"
        run: |
          if [ "${TARGET}" = "docker" ]; then
            SHORT_NAME=${INCOMMING_IMAGE##*/}
            echo "IMAGE_SHORT_NAME=${SHORT_NAME%:*}" >> "$GITHUB_OUTPUT"

            SAFE_NAME=${SHORT_NAME//:/_}
            SAFE_NAME=${SAFE_NAME//\//_}
            SAFE_NAME=${SAFE_NAME//-/_}
            if [ "${RUNNER}" != "" ]; then
              SAFE_NAME=${SAFE_NAME}_${RUNNER}
            fi

            echo "GRYPE_FILENAME=grype-${SAFE_NAME}.sarif" >> "$GITHUB_OUTPUT"
            echo "TRIVY_FILENAME=trivy-${SAFE_NAME}.sarif" >> "$GITHUB_OUTPUT"

            echo "SAFE_FILE=${SAFE_NAME}"

            echo "Prepared filenames for image scan: grype-${SAFE_NAME}.sarif, trivy-${SAFE_NAME}.sarif"
          else
            echo "GRYPE_FILENAME=grype.sarif" >> "$GITHUB_OUTPUT"
            echo "TRIVY_FILENAME=trivy.sarif" >> "$GITHUB_OUTPUT"
            echo "Prepared filenames for source scan: grype.sarif, trivy.sarif"
          fi

  grype-scan:
    if: ${{ inputs.grype-scan }}
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    needs: [init]
    steps:
      - name: Login to GHCR (docker target)
        if: ${{ inputs.target == 'docker' }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 #v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository (source target)
        if: ${{ inputs.target == 'source' }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false

      - name: "Grype scan (Docker: High+Critical)"
        if: ${{ inputs.target == 'docker' }}
        id: grype-docker
        uses: anchore/scan-action@0d444ed77d83ee2ba7f5ced0d90d640a1281d762 #v7.3.0
        with:
          image: ${{ needs.init.outputs.IMAGE }}
          output-file: ${{ needs.init.outputs.GRYPE_FILENAME }}
          fail-build: false
          severity-cutoff: critical
          only-fixed: ${{ inputs.only-fixed }}
          output-format: sarif
        continue-on-error: ${{ inputs.continue-on-error }}

      - name: "Grype scan (Source: High+Critical)"
        if: ${{ inputs.target == 'source' }}
        id: grype-source
        uses: anchore/scan-action@0d444ed77d83ee2ba7f5ced0d90d640a1281d762 #v7.3.0
        with:
          path: .
          output-file: ${{ needs.init.outputs.GRYPE_FILENAME }}
          fail-build: false
          severity-cutoff: critical
          only-fixed: ${{ inputs.only-fixed }}
          output-format: sarif
        continue-on-error: ${{ inputs.continue-on-error }}

      - name: "Convert Grype SARIF to CSV"
        env:
          ONLY_HIGH_CRITICAL: ${{ inputs['only-high-critical'] }}
          GRYPE_FILENAME: ${{ needs.init.outputs.GRYPE_FILENAME }}
        run: |
          SARIF_FILE=$GRYPE_FILENAME
          jq '. as $input
          | .runs[].results
          |= map(. + {
          security_severity: (
          $input.runs[0].tool.driver.rules[] as $rule
          | select($rule.id == .ruleId)
          | $rule.properties["security-severity"]
          )
          } +
          { info: (
          $input.runs[0].tool.driver.rules[] as $rule
          | select($rule.id == .ruleId)
          | $rule.help.text
          )
          }
          )' "$SARIF_FILE"  > "${SARIF_FILE%.sarif}.ext.sarif"
          # Filter only high and critical (>=7)
          if [ "${ONLY_HIGH_CRITICAL}" = "true" ]; then
          jq '.runs[].results |= map(
              select(
                (.security_severity | tonumber) >= 7
              ) | del(.security_severity) | del(.info)
              )' "${SARIF_FILE%.sarif}.ext.sarif" > "${SARIF_FILE%.sarif}.filtered.sarif"
              mv "${SARIF_FILE%.sarif}.filtered.sarif" "$SARIF_FILE"
          fi
          # Convert to CSV for easier reading
          SECURITY_SEVERITY_THRESHOLD='0'
          if [ "${ONLY_HIGH_CRITICAL}" = "true" ]; then
            SECURITY_SEVERITY_THRESHOLD='7'
          fi
          if [ "${TARGET}" = "docker" ]; then
          jq --raw-output --arg sst "$SECURITY_SEVERITY_THRESHOLD" '["Tool", "Image", "CVE", "Severity", "Package", "Affected Version", "Fix Version", "Summary"] as $headers | (
              $headers, (
                  .runs[0].results[] as $result | if ($result.security_severity | tonumber) >= ($sst | tonumber) then
                  [
                      ("grype"),
                      ("${{ needs.init.outputs.IMAGE }}"),
                      ($result.info | capture("Vulnerability (?<cve>.*)"; "n") | .cve),
                      ($result.security_severity | tonumber | if . < 4 then "LOW" elif . < 7 then "MEDIUM" elif . < 9 then "HIGH" else "CRITICAL" end),
                      ($result.info | capture("Package: (?<package>.*)"; "n") | .package),
                      ($result.info | capture("Version: (?<version>.*)"; "n") | .version),
                      ($result.info | capture("Fix Version: (?<fix_version>.*)"; "n") | .fix_version),
                      $result.message.text

                  ] else empty end
              )
          ) | @csv' "${SARIF_FILE%.sarif}.ext.sarif" > "${SARIF_FILE%.sarif}.csv"
          fi
          if [ "${TARGET}" = "source" ]; then
          jq --raw-output --arg sst "$SECURITY_SEVERITY_THRESHOLD" '["Tool", "CVE", "Severity", "Package", "Affected Version", "Fix Version", "Summary"] as $headers | (
              $headers, (
                  .runs[0].results[] as $result | if ($result.security_severity | tonumber) >= ($sst | tonumber) then
                  [
                      ("grype"),
                      ($result.info | capture("Vulnerability (?<cve>.*)"; "n") | .cve),
                      ($result.security_severity | tonumber | if . < 4 then "LOW" elif . < 7 then "MEDIUM" elif . < 9 then "HIGH" else "CRITICAL" end),
                      ($result.info | capture("Package: (?<package>.*)"; "n") | .package),
                      ($result.info | capture("Version: (?<version>.*)"; "n") | .version),
                      ($result.info | capture("Fix Version: (?<fix_version>.*)"; "n") | .fix_version),
                      $result.message.text

                  ] else empty end
              )
          ) | @csv' "${SARIF_FILE%.sarif}.ext.sarif" > "${SARIF_FILE%.sarif}.csv"
          fi
          rm "${SARIF_FILE%.sarif}.ext.sarif"

      - name: Upload Grype SARIF
        if: inputs.upload-sarif-to-security
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2  # v4.32.2
        with:
          sarif_file: |
            ${{ needs.init.outputs.GRYPE_FILENAME }}
          category: ${{ needs.init.outputs.IMAGE_SHORT_NAME || 'source' }}

      - name: Upload all scan artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: ${{ needs.init.outputs.GRYPE_FILENAME }}
          path: |
            ${{ needs.init.outputs.GRYPE_FILENAME }}
            *.csv

  trivy-scan:
    runs-on: ${{ inputs.runner || 'ubuntu-latest' }}
    if: ${{ inputs.trivy-scan }}
    needs: [init]
    steps:
      - name: Login to GHCR (docker target)
        if: ${{ inputs.target == 'docker' }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 #v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository (source target)
        if: ${{ inputs.target == 'source' }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false

      - name: "Trivy scan (Docker: ${{ env.TRIVY_SEVERITY }})"
        if: ${{ inputs.target == 'docker' }}
        id: trivy-docker
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 #0.33.1
        with:
          image-ref: "${{ needs.init.outputs.IMAGE }}"
          severity: ${{ env.TRIVY_SEVERITY }}
          output: ${{ needs.init.outputs.TRIVY_FILENAME }}
          format: "sarif"
          ignore-unfixed: ${{ inputs.only-fixed }}
          limit-severities-for-sarif: true
        continue-on-error: ${{ inputs.continue-on-error }}

      - name: "Trivy scan (Source: ${{ env.TRIVY_SEVERITY }})"
        if: ${{ inputs.target == 'source' }}
        id: trivy-source
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 #0.33.1
        with:
          scan-type: "fs"
          severity: ${{ env.TRIVY_SEVERITY }}
          output: ${{ needs.init.outputs.TRIVY_FILENAME }}
          format: "sarif"
          ignore-unfixed: ${{ inputs.only-fixed }}
          limit-severities-for-sarif: true
        continue-on-error: ${{ inputs.continue-on-error }}

      - name: "Convert Trivy SARIF to CSV"
        env:
          TRIVY_FILENAME: ${{ needs.init.outputs.TRIVY_FILENAME }}
        run: |
          SARIF_FILE=$TRIVY_FILENAME
          jq '. as $input
          | .runs[].results
          |= map(. + { security_severity: ($input.runs[0].tool.driver.rules[] as $rule
              | select($rule.id == .ruleId)
              | $rule.properties["security-severity"])
              } +
              { info: (
              $input.runs[0].tool.driver.rules[] as $rule
              | select($rule.id == .ruleId)
              | $rule.fullDescription.text | gsub("\n"; " ")
              )})' "$SARIF_FILE"  > "${SARIF_FILE%.sarif}.ext.sarif"

          if [ "${TARGET}" = "docker" ]; then
          jq --raw-output '["Tool", "Image", "CVE", "Severity", "Package", "Affected Version", "Fix Version", "Summary"] as $headers | (
              $headers, (
                  .runs[0].results[] as $result | [
                      ("trivy"),
                      ("${{ needs.init.outputs.IMAGE }}"),
                      ($result.ruleId),
                      ($result.message.text | capture("Severity: (?<severity>\\w+)"; "n") | .severity),
                      ($result.message.text | capture("Package: (?<package>.*)"; "n") | .package),
                      ($result.message.text | capture("Installed Version: (?<version>.*)"; "n") | .version),
                      ($result.message.text | capture("Fixed Version: (?<fix_version>.*)"; "n") | .fix_version),
                      ($result.info)
                  ]
              )
          ) | @csv' "${SARIF_FILE%.sarif}.ext.sarif" > "${SARIF_FILE%.sarif}.csv"
          fi
          if [ "${TARGET}" = "source" ]; then
          jq --raw-output '["Tool", "CVE", "Severity", "Package", "Affected Version", "Fix Version", "Summary"] as $headers | (
              $headers, (
                  .runs[0].results[] as $result | [
                      ("trivy"),
                      ($result.ruleId),
                      ($result.message.text | capture("Severity: (?<severity>\\w+)"; "n") | .severity),
                      ($result.message.text | capture("Package: (?<package>.*)"; "n") | .package),
                      ($result.message.text | capture("Installed Version: (?<version>.*)"; "n") | .version),
                      ($result.message.text | capture("Fixed Version: (?<fix_version>.*)"; "n") | .fix_version),
                      ($result.info)
                  ]
              )
          ) | @csv' "${SARIF_FILE%.sarif}.ext.sarif" > "${SARIF_FILE%.sarif}.csv"
          fi
          rm "${SARIF_FILE%.sarif}.ext.sarif"

      - name: Upload Trivy SARIF
        if: inputs.upload-sarif-to-security
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2  # v4.32.2
        with:
          sarif_file: ${{ needs.init.outputs.TRIVY_FILENAME }}
          category: ${{ needs.init.outputs.IMAGE_SHORT_NAME || 'source' }}

      - name: Upload all scan artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: ${{ needs.init.outputs.TRIVY_FILENAME }}
          path: |
            ${{ needs.init.outputs.TRIVY_FILENAME }}
            *.csv
